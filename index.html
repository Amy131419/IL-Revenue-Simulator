<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CC/BTC LP：IL 与 LP 收益模拟器</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b1020; --card:#121a33; --muted:#95a0c6; --text:#eef1ff; --line:#263158; --accent:#7aa2ff; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial; background:linear-gradient(180deg,#070b18 0%, #0b1020 45%, #070b18 100%); color:var(--text); }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px; }
    h1{ margin:0 0 8px; font-size:22px; font-weight:700; }
    p{ margin:0 0 18px; color:var(--muted); line-height:1.5; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:rgba(18,26,51,.92); border:1px solid rgba(38,49,88,.9); border-radius:18px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .row{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(38,49,88,.9); background:#0a0f22; color:var(--text); outline:none; }
    input:focus{ border-color: rgba(122,162,255,.9); box-shadow:0 0 0 3px rgba(122,162,255,.15); }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{ padding:10px 14px; border-radius:14px; border:1px solid rgba(38,49,88,.9); background:rgba(122,162,255,.14); color:var(--text); cursor:pointer; font-weight:600; }
    button:hover{ background:rgba(122,162,255,.22); }
    .kpi{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-top:12px; }
    @media (max-width: 980px){ .kpi{ grid-template-columns: repeat(2, 1fr); } }
    .kpi .box{ background:#0a0f22; border:1px solid rgba(38,49,88,.9); border-radius:14px; padding:12px; }
    .kpi .t{ font-size:12px; color:var(--muted); }
    .kpi .v{ font-size:16px; font-weight:800; margin-top:6px; }
    .hr{ height:1px; background:rgba(38,49,88,.9); margin:14px 0; }
    .small{ font-size:12px; color:var(--muted); line-height:1.5; }
    .heat{ overflow:auto; border-radius:14px; border:1px solid rgba(38,49,88,.9); }
    table{ border-collapse:collapse; width:100%; min-width:760px; background:#0a0f22; }
    th,td{ padding:8px 10px; border-bottom:1px solid rgba(38,49,88,.65); border-right:1px solid rgba(38,49,88,.35); font-size:12px; text-align:right; white-space:nowrap; }
    th{ position:sticky; top:0; background:#0d1330; z-index:2; color:var(--muted); }
    th:first-child, td:first-child{ text-align:left; position:sticky; left:0; background:#0d1330; z-index:1; }
    .legend{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:10px; }
    .chip{ display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:#0a0f22; border:1px solid rgba(38,49,88,.9); color:var(--muted); font-size:12px; }
    .sw{ width:10px; height:10px; border-radius:3px; display:inline-block; background:var(--accent); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CC/BTC LP：无常损失（IL）& LP 收益模拟器</h1>
    <p>模型：常数乘积 AMM（x·y=k），初始池子为 <b>1 BTC</b> + <b>$100,000 等值的 CC</b>（按初始 CC 价格换算数量）。可输入 BTC/CC 当前价格与正负区间，输出：IL 损益、LP vs HODL、以及叠加 APY 的净收益。</p>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">输入参数</h2>

        <div class="row">
          <div>
            <label>初始 BTC 价格（USD）</label>
            <input id="btc0" type="number" step="0.01" value="100000" />
          </div>
          <div>
            <label>初始 CC 价格（USD）</label>
            <input id="cc0" type="number" step="0.000001" value="0.07" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>当前 BTC 价格（USD）</label>
            <input id="btcNow" type="number" step="0.01" value="90259" />
          </div>
          <div>
            <label>当前 CC 价格（USD）</label>
            <input id="ccNow" type="number" step="0.000001" value="0.07" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>BTC 价格区间（±%）</label>
            <input id="btcRange" type="number" step="0.1" value="30" />
          </div>
          <div>
            <label>CC 价格区间（±%）</label>
            <input id="ccRange" type="number" step="0.1" value="300" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>步数（曲线点数 / Heatmap 档位）</label>
            <input id="steps" type="number" step="1" value="25" />
          </div>
          <div>
            <label>年化 APY（%）</label>
            <input id="apy" type="number" step="0.1" value="66" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>持仓期限（天）</label>
            <input id="days" type="number" step="1" value="365" />
          </div>
          <div>
            <label>月度网络成本（USD，可为 0）</label>
            <input id="netCostMo" type="number" step="1" value="0" />
          </div>
        </div>

        <div class="btns">
          <button id="run">计算并刷新图表</button>
          <button id="reset">重置为示例参数</button>
        </div>

        <div class="hr"></div>
        <div class="small">
          <b>说明</b>：
          <ul style="margin:8px 0 0 18px; padding:0; color:var(--muted)">
            <li>IL 的“损失/收益”是相对 <b>HODL（只持有 1 BTC + 初始换算的 CC 数量）</b> 的差额。</li>
            <li>橙线 = 在 LP 价值上额外叠加 APY 现金流，并扣除网络成本。</li>
            <li>若你的池子不是 50/50（或是 v3 集中流动性 / Curve 特定曲线），请告诉我，我可以换模型。</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 8px; font-size:16px;">当前价格下的结果（单点）</h2>
        <div class="kpi">
          <div class="box"><div class="t">HODL 价值</div><div class="v" id="k_hodl">-</div></div>
          <div class="box"><div class="t">LP 价值（不含收益）</div><div class="v" id="k_lp">-</div></div>
          <div class="box"><div class="t">IL / LP-HODL</div><div class="v" id="k_diff">-</div></div>
          <div class="box"><div class="t">净收益（含 APY & 成本）</div><div class="v" id="k_net">-</div></div>
        </div>

        <div class="hr"></div>
        <h2 style="margin:0 0 10px; font-size:16px;">曲线：固定 BTC，扫描 CC</h2>
        <canvas id="line" height="150"></canvas>
        <div class="legend">
          <span class="chip"><span class="sw"></span>蓝线：LP - HODL（仅 IL 影响）</span>
          <span class="chip"><span class="sw" style="background:#ffa45b"></span>橙线：LP - HODL（叠加 APY、扣成本）</span>
        </div>
      </div>

      <div class="card" style="grid-column:1 / -1;">
        <h2 style="margin:0 0 10px; font-size:16px;">热力表：同时扫描 BTC 与 CC（LP 净收益 vs HODL）</h2>
        <div class="small">表格单元格显示：<b>净差额（USD）</b> = (LP 价值 + 收益 - 成本) - HODL 价值。数值越大越有利于做 LP。</div>
        <div class="heat" style="margin-top:12px;">
          <table id="heatTable"></table>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Core AMM math (x*y=k), 50/50 by value at deposit time ----------
  function fmtUSD(x){
    const s = (Math.abs(x) >= 1e9) ? x.toExponential(2) : x.toLocaleString(undefined,{maximumFractionDigits:2});
    return "$" + s;
  }
  function fmtPct(x){
    return (x*100).toFixed(2) + "%";
  }

  function computePoint(params, PB, PC){
    // params: {btc0, cc0, x0, y0, k, apy, days, netCostMo}
    const {btc0, cc0, x0, y0, k, apy, days, netCostMo} = params;

    // relative price move of CC vs BTC in BTC terms:
    // initial (CC/BTC) = cc0/btc0 ; current (CC/BTC) = PC/PB
    const r = (PC / PB) / (cc0 / btc0);

    const p0 = x0 / y0;          // BTC per CC in pool at t0
    const p1 = p0 * r;           // new pool price in BTC terms after arb

    const x1 = Math.sqrt(k * p1);
    const y1 = Math.sqrt(k / p1);

    const hodl = x0 * PB + y0 * PC;
    const lp = x1 * PB + y1 * PC;

    const diff = lp - hodl;       // LP - HODL (pure IL effect in USD)
    const ilPct = lp / hodl - 1;  // IL percentage

    const years = Math.max(0, days) / 365;
    const yieldUSD = (apy/100) * (x0*btc0 + y0*cc0) * years;  // APY on initial capital
    const costUSD = (netCostMo || 0) * (Math.max(0, days) / 30);

    const net = diff + yieldUSD - costUSD;

    return {x1, y1, hodl, lp, diff, ilPct, yieldUSD, costUSD, net};
  }

  function buildParams(){
    const btc0 = +document.getElementById('btc0').value;
    const cc0  = +document.getElementById('cc0').value;
    const x0   = 1.0;
    const y0   = 100000 / cc0;        // $100k worth of CC at initial CC price
    const k    = x0 * y0;
    const apy  = +document.getElementById('apy').value;
    const days = +document.getElementById('days').value;
    const netCostMo = +document.getElementById('netCostMo').value;
    return {btc0, cc0, x0, y0, k, apy, days, netCostMo};
  }

  let lineChart;

  function refresh(){
    const params = buildParams();

    const btcNow = +document.getElementById('btcNow').value;
    const ccNow  = +document.getElementById('ccNow').value;
    const btcRange = +document.getElementById('btcRange').value / 100;
    const ccRange  = +document.getElementById('ccRange').value / 100;
    const steps = Math.max(5, Math.min(60, Math.floor(+document.getElementById('steps').value || 25)));

    // ----- Single point KPIs -----
    const pt = computePoint(params, btcNow, ccNow);
    document.getElementById('k_hodl').textContent = fmtUSD(pt.hodl);
    document.getElementById('k_lp').textContent   = fmtUSD(pt.lp);
    document.getElementById('k_diff').textContent = `${fmtUSD(pt.diff)} (${fmtPct(pt.ilPct)})`;
    document.getElementById('k_net').textContent  = `${fmtUSD(pt.net)}  (收益 ${fmtUSD(pt.yieldUSD)} - 成本 ${fmtUSD(pt.costUSD)})`;

    // ----- Line chart: fix BTC=btcNow, scan CC -----
    const ccMin = Math.max(1e-12, ccNow * (1 - ccRange));
    const ccMax = Math.max(ccMin*1.001, ccNow * (1 + ccRange));

    const labels = [];
    const diffSeries = [];
    const netSeries = [];

    for(let i=0;i<steps;i++){
      const t = i/(steps-1);
      const PC = ccMin + (ccMax - ccMin) * t;
      const res = computePoint(params, btcNow, PC);
      labels.push(PC);
      diffSeries.push(res.diff);
      netSeries.push(res.net);
    }

    const ctx = document.getElementById('line');
    if(lineChart) lineChart.destroy();
    lineChart = new Chart(ctx, {
      type:'line',
      data:{
        labels: labels,
        datasets:[
          {
            label:'LP - HODL（仅 IL）',
            data: diffSeries,
            borderWidth:2,
            pointRadius:0,
            tension:0.25
          },
          {
            label:'LP - HODL（含 APY - 成本）',
            data: netSeries,
            borderWidth:2,
            pointRadius:0,
            tension:0.25
          }
        ]
      },
      options:{
        responsive:true,
        plugins:{
          tooltip:{
            callbacks:{
              title:(items)=> `CC = $${(+items[0].label).toFixed(6)}`,
              label:(item)=> `${item.dataset.label}: ${fmtUSD(item.raw)}`
            }
          },
          legend:{ labels:{ color:'#95a0c6' } }
        },
        scales:{
          x:{
            ticks:{ color:'#95a0c6', callback:(v, idx)=> idx%Math.ceil(steps/6)===0 ? "$"+labels[idx].toFixed(3) : "" },
            grid:{ color:'rgba(38,49,88,.35)' }
          },
          y:{
            ticks:{ color:'#95a0c6', callback:(v)=> (v>=0?"":"-")+"$"+Math.abs(v).toLocaleString(undefined,{maximumFractionDigits:0}) },
            grid:{ color:'rgba(38,49,88,.35)' }
          }
        }
      }
    });

    // color second dataset (orange-ish) without hardcoding chart palette globally
    lineChart.data.datasets[1].borderColor = '#ffa45b';
    lineChart.update();

    // ----- Heat table: scan both BTC & CC around current -----
    const PBmin = Math.max(1e-12, btcNow * (1 - btcRange));
    const PBmax = Math.max(PBmin*1.001, btcNow * (1 + btcRange));

    const PCmin = Math.max(1e-12, ccNow * (1 - ccRange));
    const PCmax = Math.max(PCmin*1.001, ccNow * (1 + ccRange));

    const n = Math.max(8, Math.min(26, steps));

    const PBs = Array.from({length:n}, (_,i)=> PBmin + (PBmax-PBmin)*i/(n-1));
    const PCs = Array.from({length:n}, (_,i)=> PCmin + (PCmax-PCmin)*i/(n-1));

    // build table HTML
    const tbl = document.getElementById('heatTable');
    let html = '<thead><tr><th>BTC \\ CC</th>';
    for(const PC of PCs){ html += `<th>$${PC.toFixed(4)}</th>`; }
    html += '</tr></thead><tbody>';

    // helper: map value to bg
    function bgColor(v){
      // normalize roughly around +/- 200k
      const cap = 200000;
      const t = Math.max(-1, Math.min(1, v / cap));
      // green for positive, red for negative (simple, readable)
      const a = Math.round(18 + 38*Math.abs(t));
      if(t >= 0) return `rgba(60, 200, 120, ${a/100})`;
      return `rgba(240, 90, 90, ${a/100})`;
    }

    for(const PB of PBs){
      html += `<tr><td>$${PB.toFixed(0)}</td>`;
      for(const PC of PCs){
        const res = computePoint(params, PB, PC);
        const v = res.net;
        html += `<td style="background:${bgColor(v)}">${(v>=0?"":"-")}$${Math.abs(v).toLocaleString(undefined,{maximumFractionDigits:0})}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody>';
    tbl.innerHTML = html;
  }

  document.getElementById('run').addEventListener('click', refresh);
  document.getElementById('reset').addEventListener('click', ()=>{
    document.getElementById('btc0').value = 100000;
    document.getElementById('cc0').value = 0.07;
    document.getElementById('btcNow').value = 90259;
    document.getElementById('ccNow').value = 0.07;
    document.getElementById('btcRange').value = 30;
    document.getElementById('ccRange').value = 300;
    document.getElementById('steps').value = 25;
    document.getElementById('apy').value = 66;
    document.getElementById('days').value = 365;
    document.getElementById('netCostMo').value = 0;
    refresh();
  });

  // auto-run on load
  refresh();
</script>
</body>
</html>
